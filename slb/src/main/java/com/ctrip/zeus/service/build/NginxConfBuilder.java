package com.ctrip.zeus.service.build;

import com.ctrip.zeus.model.model.*;
import com.ctrip.zeus.model.nginx.ConfFile;
import com.ctrip.zeus.service.Repository;
import com.ctrip.zeus.service.model.snapshot.ModelSnapshotEntity;

import java.util.List;
import java.util.Map;
import java.util.Set;

/**
 * Created by fanqq on 2015/3/30.
 */
public interface NginxConfBuilder extends Repository {

    /**
     * generate nginx config
     *
     * @param slb the slb entity
     * @param defaultRules
     * @return nginx  config
     * @throws Exception
     */
    String generateNginxConf(Slb slb, List<Rule> defaultRules, ModelSnapshotEntity snapshot) throws Exception;

    /**
     * generate nginx server confs
     *
     * @param slb      the under building slb
     * @param vs       the under building virtual server
     * @param policies policies of the vs
     * @param groups   groups of the vs
     * @return nginx server confs
     * @throws Exception
     */
    String generateServerConf(Slb slb, VirtualServer vs, List<TrafficPolicy> policies, List<Group> groups, Map<Long,
            Map<Long, Integer>> drDesSlbByGroupIds, Map<Long, Dr> drByGroupIds, Map<Long, String> canaryIpMap, List<Rule> defaultRules, ModelSnapshotEntity snapshot) throws Exception;

    /**
     * Get nginx upstream conf files. Conf name is generated by related vs-id joined by '_'.
     * Not all input groups will get a corresponding upstream conf according to generation rule described above.
     *
     * @param vsCandidates
     * @param vs
     * @param groups
     * @param allDownServers
     * @param allUpGroupServers
     * @param visited           generated vs files
     * @param defaultRules
     * @param nxOnlineSlb
     * @return upstream conf file list
     * @throws Exception
     */
    List<ConfFile> generateUpstreamsConf(Set<Long> vsCandidates, VirtualServer vs, List<Group> groups,
                                         Set<String> allDownServers, Set<String> allUpGroupServers,
                                         Set<String> visited, List<Rule> defaultRules, Slb nxOnlineSlb) throws Exception;
}
